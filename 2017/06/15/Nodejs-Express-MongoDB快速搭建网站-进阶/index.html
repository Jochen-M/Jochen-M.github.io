<!DOCTYPE html>
<html style="display: none;" lang="en">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            Nodejs-Express-MongoDB快速搭建网站(进阶) | 
        
        Jochen-M
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Jochen-M">
    <meta name="description" itemprop="description" content="The journey of a thousand miles begins with a single step.">
    <meta name="keywords" content="Jochen,jochen,hexo,Nodejs,Express,MongoDB">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Jochen-M">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://jochen-m.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Nodejs-Express-MongoDB快速搭建网站(进阶) | Jochen-M">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="The journey of a thousand miles begins with a single step.">
    <meta property="og:article:tag" content="Nodejs"> <meta property="og:article:tag" content="Express"> <meta property="og:article:tag" content="MongoDB"> 

    
        <meta property="article:published_time" content="Jun 15, 2017" />
        <meta property="article:modified_time" content="Sep 19, 2017" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Nodejs-Express-MongoDB快速搭建网站(进阶) | Jochen-M">
    <meta name="twitter:description" content="The journey of a thousand miles begins with a single step.">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://jochen-m.github.io" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Jochen-M",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "Jochen-M",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "Do the thing you think you cannot do."
    },
    "headline": "Nodejs-Express-MongoDB快速搭建网站(进阶)",
    "url": "http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html",
    "datePublished": "Jun 15, 2017",
    "dateModified": "Sep 19, 2017",
    "description": "The journey of a thousand miles begins with a single step.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://jochen-m.github.io"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    .footer-sns-gplus {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHpNNDMwIDI5NS40YzQwLjYgMTUuNCA1Ni42IDIzLjggNzIuNiAzOC40IDYuOCA2LjIgNy4yIDE1LjIgMSAyMy40LTYuMiA4LTMzLjYgMzMuOC0zOSAzNi42LTUuNiAyLjgtMTcuNiAyLjgtMjMuMi0uMi0yLjQtMS4yLTguMi01LjItMTMtOC44LTExLjItOC42LTI0LjYtMTEuMi01NS4yLTExLjItMjcuNCAwLTQwLjYgMi42LTUyLjIgMTAuNC00LjQgMi44LTEyLjIgNy42LTE3LjIgMTAuNi0yMyAxMy4yLTUxLjQgNTUtNTUuOCA4Mi40LTIuNiAxNS42LTIuNCAzNC44LjIgNTEgMi44IDE3LjQgMTkuOCA0OC44IDM1LjIgNjUuMiAxNiAxNi42IDQ1IDMzLjYgNjIuOCAzNi42IDI2LjggNC40IDY1LjggMS42IDc5LjQtNS44IDIwLjYtMTEuNCAzMS0xOSA0MS0zMC40IDE4LjgtMjEuNiAyMy40LTM0LjIgMTUuNi00My44LTMuOC00LjgtNC40LTQuOC01MS01LjgtNjAuOC0xLjItNTYuMiAyLjItNTYuMi00My4yIDAtMzIuNC4yLTMzLjIgNC44LTM3IDQuNC0zLjYgOS0zLjggOTItMy44IDc5IDAgODcuOC40IDk0LjIgMy42IDExLjIgNS42IDEzIDExLjQgMTIuOCA0My40IDAgMjUuNC0uOCAzMC44LTcuNiA1OC00IDE2LjYtOS44IDM0LTEyLjYgMzktMi44IDUtOC4yIDE0LjItMTEuNiAyMC42LTguNCAxNS40LTI3LjIgMzYuOC00MC44IDQ2LjYtNS44IDQuNC0xMy44IDEwLjItMTcuNiAxMy4yLTMuOCAzLTExIDctMTYuMiA4LjgtNS4yIDEuOC0xNi4yIDYuNC0yNC40IDEwLTIyLjQgOS42LTM0LjggMTEuNi03MyAxMS42LTM3LjYuMi00Ny0xLjQtNzEtMTItOC4yLTMuNi0xNy42LTcuMi0yMC44LTgtMTUuOC0zLjgtNjctNDUuMi03Ny44LTYyLjgtMi4yLTMuOC03LjYtMTEuNi0xMS44LTE3LjItNC4yLTUuNC05LTE0LTEwLjYtMTktMS44LTQuOC02LjItMTYtMTAtMjQuOC0zLjYtOC44LTcuOC0yMi4yLTkuMi0yOS42LTMuMi0xOC44LTEuNC03OS40IDIuOC05MS40IDEzLjgtNDAuNiAzNS42LTc4IDU4LjgtMTAwLjIgMTQtMTMuNiA0Ny4yLTM2LjQgNTgtMzkuOCA0LjItMS40IDEzLjQtNS4yIDIwLjYtOC40IDIyLTEwIDMyLjgtMTEuNiA3Ni0xMSAzMy44LjYgNDAuNCAxLjIgNTAgNC44em0zNDAuOCA4MC44YzggMy42IDkuNiAxMS4yIDkuMiAzOS4yLS42IDM0LjQtLjYgMzQgNSAzOS42IDQuOCA1IDUuNCA1IDM3LjYgNSA0My40IDAgNDQuNC44IDQzLjIgMzYuMi0uOCAxNy0xLjIgMTguNC02LjQgMjMtNS40IDQuNi02LjYgNC44LTM3LjYgNC44LTMxLjIgMC0zMiAuMi0zNi44IDUtNS42IDUuNC01LjYgNC40LTUgNDEuMi40IDI2LjQuMiAyNy40LTQuNiAzMy00LjggNS42LTYgNS44LTI0LjQgNi40LTIwLjguOC0yOS42LTEuNC0zMy40LTguNC0xLjQtMi42LTItMTUuNi0xLjgtMzUuNi40LTMxLjIuNC0zMS42LTQuNi0zNi42cy01LjYtNS0zNi01Yy0xOC44IDAtMzMtLjgtMzYtMi4yLTcuNi0zLjYtOS42LTExLjItOC44LTMzLjguOC0yOC4yLjQtMjggNDEtMjggNDUuNCAwIDQ1LjQgMCA0NC42LTQyLjYtLjYtMzMtLjYtMzMgNS0zOC40IDQuNC00LjYgNi4yLTUgMjQuOC01IDExIDAgMjIuMiAxIDI1IDIuMnoiLz48L3N2Zz4=);
    }
    
    
    .footer-sns-weibo {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzUuMiA3OWMtOC42IDMtMjIuOCAxMi40LTMyLjggMjEuOC04LjIgNy44LTIyLjIgMzEtMjQuNiA0MC42LTEgNC4yLTEuNiAxNjctMS42IDM2NC42IDAgMjg0LjguNCAzNTguNCAyLjYgMzY0IDEuNCAzLjggNi44IDEzIDEyIDIwLjQgOC44IDEyLjggMjQgMjUuNCA0MS44IDM1IDYgMy40IDI3IDMuNiAzNjcuNCAzLjYgMjg2LjIgMCAzNjIuNi0uNiAzNjktMi42IDE5LjgtNi4yIDUxLjItMzcuNiA1Ny40LTU3LjQgMi02LjQgMi42LTgyLjYgMi42LTM2OFYxNDFsLTQuMi05Yy0xMS42LTI0LTM5LjItNDkuOC01OC4yLTU0LjItNC4yLTEtMTY4LjYtMS42LTM2NS42LTEuNi0zMDAgMC0zNTkuMi40LTM2NS44IDIuOHptNTU4LjYgMTY5YzguNiAxLjIgMTYuNCA0IDI0IDguNiA2LjIgMy42IDE1LjIgOC4yIDIwLjIgMTAuMiA1LjggMi4yIDE0LjYgOC44IDI1IDE4LjggMjUuNCAyNC44IDMyLjggMzQuOCAzNy44IDUxIDIuNiA4IDcuNCAxOS44IDEwLjggMjYuNCA3LjggMTQuNiAxMS42IDQyLjYgOS40IDY5LTEgMTQuMi0yLjIgMTguNi03LjQgMjYuNC0zLjIgNS4yLTkgMTIuMi0xMi44IDE1LjYtMTMuOCAxMi0zNCA1LjgtMzguOC0xMi0xLjYtNi0xLjQtMTEuNCAxLjItMjMuNCA0LjItMjAgMy00Ni0yLjYtNTguNi0yLjItNS04LTEyLjYtMTIuOC0xNi44LTQuOC00LjItMTQuNi0xNi40LTIxLjgtMjYuOC03LjItMTAuNi0xNS4yLTIwLjgtMTgtMjIuOC0yLjgtMi0xMi42LTYtMjItOS0xNC40LTQuNC0yMC44LTUuNC00My01LjYtMjgtLjItMzEuNC0xLjItNDIuNC0xMS42LTcuNC03LTguNi0xNS42LTMuOC0yNS4yIDctMTMuMiAxNi40LTE2IDU0LjItMTYgMTYuNiAwIDM1LjguOCA0Mi44IDEuOHptLTIxMy42IDc1LjZjMjAuMiAxNS40IDIwLjYgMTYuNCAyMiA0OCAuNiAxNSAxLjggMjkgMi42IDMxIDIuOCA2LjIgMTEgNi42IDIxLjYuNiA1LjQtMy4yIDE0LTUuOCAyMC02LjQgNS44LS42IDE4LjgtMi40IDI5LTQuMiAxNy4yLTMgMTkuNC0zIDM2IC40IDMyIDYuNiAzNS44IDkuMiA0NC4yIDMxLjYgNS4yIDE0IDUuNCAyMS40IDEuMiAzMi44LTIuMiA1LjQtMi44IDExLTIgMTUuNCAxLjggMTAgMTcuNiAyMy40IDM1IDMwLjIgMTEuMiA0LjIgMTYuMiA3LjYgMjcgMTkgMTkuMiAxOS44IDIwLjIgMjMgMjAgNTktLjIgMzUtLjQgMzUuNC0xOS44IDYzLjYtMTMuOCAxOS44LTMyLjQgMzguNi00OSA1MC01IDMuNC0xMi4yIDguOC0xNS44IDEyLTMuOCAzLjItMTEuNiA4LTE3LjIgMTAuNC01LjYgMi42LTE0LjYgNy40LTE5LjggMTAuNi01LjIgMy40LTE1LjggNy42LTIzLjggOS40LTggMi0yMS4yIDYuNi0yOS42IDEwLjItMjIuNCAxMC0zNi4yIDExLjItMTIxLjggMTAuNGwtNzUtLjYtMTktOC40Yy0xMC42LTQuNi0yNS40LTkuOC0zMy0xMS42LTcuNi0xLjYtMTgtNS44LTIzLTlzLTE0LjItOC0yMC40LTEwLjhjLTE4LTgtNTkuNC00Ni4yLTY2LTYxLjItMi4yLTUtNy40LTE0LjQtMTEuNC0yMC44bC03LjItMTJWNTQ5bDcuNi0xMy42YzQuMi03LjQgOS40LTE4LjYgMTEuNi0yNC44IDMuOC0xMS40IDEzLjQtMjcuOCAyNC44LTQyLjYgMjAuMi0yNi4yIDM4LjQtNDYuOCA1My02MCA5LjItOC4yIDIxLTE4LjYgMjYtMjMuMiA1LTQuNCAxMy4yLTExIDE4LjYtMTQuNiA1LjItMy40IDkuNC03LjIgOS40LTggMC0xIDUuNi00LjYgMTIuNi04LjIgNi44LTMuOCAxNi40LTkuNiAyMS40LTEzLjIgNS0zLjYgMTQuNC04IDIxLTkuOCA2LjYtMiAxNy44LTYuNiAyNS0xMC4yIDEyLTYuMiAxNC40LTYuOCAzMi40LTYuOGgxOS40bDEyLjQgOS42em0yMDMuNiAxMy4yYzMgMS42IDYuNiA0LjQgOCA2IDEuNiAxLjggOS40IDcgMTcuNCAxMS42IDE3IDkuNiAxOSAxMyAyNCA0MiAzLjQgMjAuNCAyLjYgMzIuMi0zLjQgNDMuOC03LjYgMTUuMi0yMi44IDIwLjYtMzEuMiAxMS4yLTctNy42LTkuMi0xMy44LTEwLjYtMjkuNi0xLjItMTMuMi0yLjQtMTYuNC05LjYtMjcuMi0xMS0xNi0xNi44LTIwLjYtMjcuMi0yMC42LTEwIDAtMjQtNi4yLTI3LTExLjYtNS44LTEwLjguNC0yNC42IDEyLjQtMjguNCA4LjYtMi42IDQwLjItLjggNDcuMiAyLjh6Ii8+PHBhdGggZD0iTTQyNCA0NzcuNGMtMzIuNiAzLjYtNDcuOCA3LTYxLjggMTMuOC04IDQtMTkgOC40LTI0LjIgMTAtNS4yIDEuNi0xMi40IDUtMTYuMiA3LjgtMy44IDIuNi0xMSA3LjYtMTYuMiAxMS0xMy40IDguOC0zNSAzMy4yLTM4LjggNDQtMS44IDUtNS40IDE0LjQtOC4yIDIxLTguOCAyMS4yLTguMiAyNi44IDQgNTMgMTAuNiAyMi42IDExIDIzLjIgMjcuNiAzNi40IDIxIDE2LjggMjMuNiAxOC40IDUwLjggMjguMiAyMC4yIDcuMiAyNC42IDggNTQgMTAgMTcuNiAxLjIgNDUuNiAyLjIgNjIgMi4ybDMwIC4yIDE3LjQtOC40YzkuNi00LjYgMjIuNC05LjYgMjguMi0xMS40IDYtMS44IDE1LjQtNi4yIDIwLjgtMTAgNS40LTMuNiAxMy40LTguNiAxNy42LTEwLjggOS4yLTQuNiAzOS0zNC40IDM5LTM5IDAtMS42IDMuOC0xMC4yIDguNC0xOC44IDcuOC0xNC4yIDguNi0xNi44IDguNC0yOS42LS4yLTEyLjgtMS0xNS44LTEwLjYtMzQuNi0xMy40LTI2LjItMzAuNC00My42LTUwLjItNTEuNC03LjItMi44LTE2LjItNy0yMC05LjYtMTEuNC03LjYtMTcuNi05LjItNDguOC0xMi40LTI3LjYtMi44LTU2LjYtMy40LTczLjItMS42em0zOS40IDQ0LjRjMTEuMiAyLjIgMjIuNiA1IDI1IDYuNCA3IDMuNiAyNiAyMS44IDMwLjggMjkuNCA4LjYgMTMuNCAxMSA1NCA0LjYgNzctMi42IDkuNi0xOC44IDI3LjYtMzkuNCA0NC4yLTE1LjYgMTIuNC0xNyAxMy0yOS44IDE0LTcuNi44LTIyLjQgMi4yLTMzIDMuNi0yMi42IDIuNi00NS42IDEtNTMuOC0zLjgtMy4yLTItOC02LjgtMTAuOC0xMC44LTIuNi00LjItOC40LTEwLjQtMTIuOC0xMy44LTguMi02LjgtMTMuNC0xNi40LTE5LjQtMzctMy44LTEzLjItMi44LTIxLjggNS4yLTQ3LjYgMy4yLTEwLjQgNi0xNC42IDE3LjQtMjUuOCAxMi40LTEyLjIgMjMuOC0yMi4yIDMzLjItMjkuNiA0LTMgMzguNi05LjQgNTMuNC05LjggNSAwIDE4LjIgMS42IDI5LjQgMy42eiIvPjxwYXRoIGQ9Ik0zODcuMiA2MDZjLTEyLjIgMy44LTE4LjIgMTMuNC0xNSAyNC42IDUuOCAyMS4yIDI3LjggMjUuOCA0MC42IDguNiA2LjYtOC44IDcuOC0xNi4yIDQuMi0yNC00LjgtMTAuMi0xNS40LTEzLjQtMjkuOC05LjJ6Ii8+PC9zdmc+);
    }
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#开发用户的注册登录功能"><span class="post-toc-number">1.</span> <span class="post-toc-text">开发用户的注册登录功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#用户模型及密码处理"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">用户模型及密码处理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#登录注册前端视图"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">登录注册前端视图</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#注册用户后台存储"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">注册用户后台存储</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#实现登录逻辑"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">实现登录逻辑</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#利用mongodb做会话的持久化"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">利用mongodb做会话的持久化</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#注销用户、用户退出功能实现"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">注销用户、用户退出功能实现</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置入口文件app-js"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">配置入口文件app.js:</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#调整目录结构，彻底分离MVC层"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">调整目录结构，彻底分离MVC层</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#增加注册登录跳转页面"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">增加注册登录跳转页面</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#用户权限管理"><span class="post-toc-number">1.10.</span> <span class="post-toc-text">用户权限管理</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#开发评论和回复功能"><span class="post-toc-number">2.</span> <span class="post-toc-text">开发评论和回复功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设计评论和回复的数据模型"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">设计评论和回复的数据模型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#评论及回复的存储与展现"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">评论及回复的存储与展现</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#电影分类功能的实现"><span class="post-toc-number">3.</span> <span class="post-toc-text">电影分类功能的实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分类的数据模型"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">分类的数据模型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分类后台录入及存储"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">分类后台录入及存储</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#增加路由信息"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">增加路由信息</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#分类的控制器"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">分类的控制器</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#增加相关页面"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">增加相关页面</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#电影录入增加分类选择"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">电影录入增加分类选择</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#为电影增加字段"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">为电影增加字段</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#增加“电影分类”表单项"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">增加“电影分类”表单项</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#修改movie控制器"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">修改movie控制器</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分类效果展示"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">分类效果展示</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#首页控制器"><span class="post-toc-number">3.4.1.</span> <span class="post-toc-text">首页控制器</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#首页视图"><span class="post-toc-number">3.4.2.</span> <span class="post-toc-text">首页视图</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#jsonp同步豆瓣数据"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">jsonp同步豆瓣数据</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#电影录入增加自定义分类"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">电影录入增加自定义分类</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#增加分类列表及分页"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">增加分类列表及分页</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#搜索功能的实现"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">搜索功能的实现</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#上传海报"><span class="post-toc-number">3.9.</span> <span class="post-toc-text">上传海报</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#访客统计"><span class="post-toc-number">3.10.</span> <span class="post-toc-text">访客统计</span></a></li></ol></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Nodejs-Express-MongoDB快速搭建网站(进阶)
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Jochen-M</strong>
        <span>Jun 15, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Express/">Express</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/MongoDB/">MongoDB</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Nodejs/">Nodejs</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Nodejs-Express-MongoDB快速搭建网站(进阶)&url=http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                Share to Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Nodejs-Express-MongoDB快速搭建网站(进阶)&url=http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html&via=Jochen-M" target="_blank">
            <li class="mdl-menu__item">
                Share to Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://jochen-m.github.io/2017/06/15/Nodejs-Express-MongoDB快速搭建网站-进阶/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="开发用户的注册登录功能"><a href="#开发用户的注册登录功能" class="headerlink" title="开发用户的注册登录功能"></a>开发用户的注册登录功能</h3><h4 id="用户模型及密码处理"><a href="#用户模型及密码处理" class="headerlink" title="用户模型及密码处理"></a>用户模型及密码处理</h4><p>schemas/user.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">let mongoose = require(&apos;mongoose&apos;);</div><div class="line">let bcrypt = require(&quot;bcrypt&quot;);</div><div class="line">const SALT_WORK_FACTOR = 10;</div><div class="line"></div><div class="line">let UserSchema = new mongoose.Schema(&#123;</div><div class="line">  name: &#123;</div><div class="line">    unique: true,</div><div class="line">    type: String</div><div class="line">  &#125;,</div><div class="line">  password: String,</div><div class="line">  meta: &#123;</div><div class="line">    createAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;,</div><div class="line">    updateAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">UserSchema.pre(&apos;save&apos;, function(next)&#123;</div><div class="line">  let user = this;</div><div class="line">  if(this.isNew)&#123;</div><div class="line">    this.meta.createAt = this.meta.updateAt = Date.now();</div><div class="line">  &#125;else&#123;</div><div class="line">    this.meta.updateAt = Date.now();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 将密码与盐混合后加密处理</div><div class="line">  bcrypt.genSalt(SALT_WORK_FACTOR, function(err, salt)&#123;</div><div class="line">    if(err) return next(err);</div><div class="line"></div><div class="line">    bcrypt.hash(user.password, salt, function(err, hash)&#123;</div><div class="line">      if(err) return next(err);</div><div class="line"></div><div class="line">      user.password = hash;</div><div class="line">      next();</div><div class="line">    &#125;)</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">UserSchema.methods = &#123;</div><div class="line">  /**</div><div class="line">   * 验证密码是否正确</div><div class="line">   */</div><div class="line">  verifyPassword: function(_password, cb)&#123;</div><div class="line">    bcrypt.compare(_password, this.password, function(err, isMatch)&#123;</div><div class="line">      if(err)&#123;</div><div class="line">        return cb(err);</div><div class="line">      &#125;</div><div class="line">      cb(null, isMatch);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">UserSchema.statics = &#123;</div><div class="line">  fetch: function(callback)&#123;</div><div class="line">    return this</div><div class="line">      .find(&#123;&#125;)</div><div class="line">      .sort(&apos;meta.updateAt&apos;)</div><div class="line">      .exec(callback);</div><div class="line">  &#125;,</div><div class="line">  findById: function(id, callback)&#123;</div><div class="line">    return this</div><div class="line">      .findOne(&#123;_id: id&#125;)</div><div class="line">      .exec(callback);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">module.exports = UserSchema</div></pre></td></tr></table></figure></p>
<h4 id="登录注册前端视图"><a href="#登录注册前端视图" class="headerlink" title="登录注册前端视图"></a>登录注册前端视图</h4><p>修改head.jade文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">.navbar.navbar-default</div><div class="line">  .container</div><div class="line">    .navbar-header</div><div class="line">      a.navbar-brand(href=&quot;/&quot;) MovieGoGo</div><div class="line">    p.navbar-text.navbar-right</div><div class="line">      a.navbar-link(href=&quot;#&quot;, data-toggle=&quot;modal&quot;, data-target=&quot;#signupModal&quot;) 注册</div><div class="line">      span &amp;nbsp;|&amp;nbsp;</div><div class="line">      a.navbar-link(href=&quot;#&quot;, data-toggle=&quot;modal&quot;, data-target=&quot;#signinModal&quot;) 登录</div><div class="line">#signupModal.modal.fade</div><div class="line">  .modal-dialog</div><div class="line">    .modal-content</div><div class="line">      form(method=&quot;POST&quot;, action=&quot;/user/signup&quot;)</div><div class="line">        .modal-header 注册</div><div class="line">        .modal-body</div><div class="line">          .form-group</div><div class="line">            label(for=&quot;signupName&quot;) 用户名</div><div class="line">            input#signupName.form-control(name=&quot;user[name]&quot;, type=&quot;text&quot;)</div><div class="line">          .form-group</div><div class="line">            label(for=&quot;signupPassword&quot;) 密码</div><div class="line">            input#signupName.form-control(name=&quot;user[password]&quot;, type=&quot;password&quot;)</div><div class="line">        .modal-footer</div><div class="line">          button.btn.btn-danger(type=&quot;button&quot;, data-dismiss=&quot;modal&quot;) 关闭</div><div class="line">          button.btn.btn-success(type=&quot;submit&quot;) 提交</div><div class="line">#signinModal.modal.fade</div><div class="line">  .modal-dialog</div><div class="line">    .modal-content</div><div class="line">      form(method=&quot;POST&quot;, action=&quot;/user/signin&quot;)</div><div class="line">        .modal-header 登录</div><div class="line">        .modal-body</div><div class="line">          .form-group</div><div class="line">            label(for=&quot;signinName&quot;) 用户名</div><div class="line">            input#signinName.form-control(name=&quot;user[name]&quot;, type=&quot;text&quot;)</div><div class="line">          .form-group</div><div class="line">            label(for=&quot;signinPassword&quot;) 密码</div><div class="line">            input#signinName.form-control(name=&quot;user[password]&quot;, type=&quot;password&quot;)</div><div class="line">        .modal-footer</div><div class="line">          button.btn.btn-danger(type=&quot;button&quot;, data-dismiss=&quot;modal&quot;) 关闭</div><div class="line">          button.btn.btn-success(type=&quot;submit&quot;) 登录</div></pre></td></tr></table></figure></p>
<h4 id="注册用户后台存储"><a href="#注册用户后台存储" class="headerlink" title="注册用户后台存储"></a>注册用户后台存储</h4><p>app.js文件中添加代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">let User = require(&apos;./models/user&apos;);</div><div class="line"></div><div class="line">// signup</div><div class="line">app.post(&apos;/user/signup&apos;, function(req, res)&#123;</div><div class="line">  let _user = req.body.user;</div><div class="line"></div><div class="line">  User.find(&#123;name: _user.name&#125;, function(err, user)&#123;</div><div class="line">    if(err)&#123;</div><div class="line">      console.log(err);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(user.length &gt; 0)&#123;</div><div class="line">      return res.redirect(&quot;/&quot;);</div><div class="line">    &#125;else&#123;</div><div class="line">      let user = new User(_user);</div><div class="line"></div><div class="line">      user.save(function(err, user)&#123;</div><div class="line">        if(err)&#123;</div><div class="line">          console.log(err);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        res.redirect(&apos;/admin/userlist&apos;);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="实现登录逻辑"><a href="#实现登录逻辑" class="headerlink" title="实现登录逻辑"></a>实现登录逻辑</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">// signin</div><div class="line">app.post(&apos;/user/signin&apos;, function(req, res)&#123;</div><div class="line">  let user_form = req.body.user;</div><div class="line">  let name = user_form.name;</div><div class="line">  let password = user_form.password;</div><div class="line"></div><div class="line">  User.findOne(&#123;name: name&#125;, function(err, _user)&#123;</div><div class="line">    if(err)&#123;</div><div class="line">      console.log(err);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(!_user)&#123;</div><div class="line">      return res.redirect(&apos;/&apos;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    let user = new User(_user);</div><div class="line">    user.verifyPassword(password, function(err, isMatch)&#123;</div><div class="line">      if(err)&#123;</div><div class="line">        console.log(err);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if(isMatch)&#123;</div><div class="line">        console.log(&quot;Password is matched&quot;);</div><div class="line">        req.session.user = user;</div><div class="line">        return res.redirect(&apos;/&apos;);</div><div class="line">      &#125;else&#123;</div><div class="line">        console.log(&quot;Password is not matched&quot;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="利用mongodb做会话的持久化"><a href="#利用mongodb做会话的持久化" class="headerlink" title="利用mongodb做会话的持久化"></a>利用mongodb做会话的持久化</h4><p>app.js文件中添加代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">let cookieParser = require(&apos;cookie-parser&apos;);</div><div class="line">let session = require(&apos;express-session&apos;);</div><div class="line">let mongoStore = require(&apos;connect-mongo&apos;)(session);</div><div class="line"></div><div class="line">app.use(cookieParser());</div><div class="line">app.use(session(&#123;</div><div class="line">  secret: &apos;moviegogo&apos;,</div><div class="line">  store: new mongoStore(&#123;</div><div class="line">    url: dbUrl,</div><div class="line">    collection: &apos;sessions&apos;</div><div class="line">  &#125;)</div><div class="line">&#125;));</div></pre></td></tr></table></figure></p>
<h4 id="注销用户、用户退出功能实现"><a href="#注销用户、用户退出功能实现" class="headerlink" title="注销用户、用户退出功能实现"></a>注销用户、用户退出功能实现</h4><p>修改head.jade文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">.navbar.navbar-default</div><div class="line">  .container</div><div class="line">    .navbar-header</div><div class="line">      a.navbar-brand(href=&quot;/&quot;) MovieGoGo</div><div class="line">    if user</div><div class="line">      p.navbar-text.navbar-right</div><div class="line">        span 欢迎您,#&#123;user.name&#125;</div><div class="line">        span &amp;nbsp;|&amp;nbsp;</div><div class="line">        a.navbar-link(href=&quot;/logout&quot;) 退出</div><div class="line">    else</div><div class="line">      p.navbar-text.navbar-right</div><div class="line">        a.navbar-link(href=&quot;#&quot;, data-toggle=&quot;modal&quot;, data-target=&quot;#signupModal&quot;) 注册</div><div class="line">        span &amp;nbsp;|&amp;nbsp;</div><div class="line">        a.navbar-link(href=&quot;#&quot;, data-toggle=&quot;modal&quot;, data-target=&quot;#signinModal&quot;) 登录</div></pre></td></tr></table></figure></p>
<p>app.js文件中添加代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// pre handle user</div><div class="line">app.use(function(req, res, next)&#123;</div><div class="line">    let _user = req.session.user;</div><div class="line"></div><div class="line">    if(_user)&#123;</div><div class="line">        app.locals.user = _user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// logout</div><div class="line">app.get(&apos;/logout&apos;, function(req, res)&#123;</div><div class="line">  delete req.session.user;</div><div class="line">  delete app.locals.user;</div><div class="line">  res.redirect(&apos;/&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="配置入口文件app-js"><a href="#配置入口文件app-js" class="headerlink" title="配置入口文件app.js:"></a>配置入口文件app.js:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">let logger = require(&apos;morgan&apos;);</div><div class="line"></div><div class="line">// 用于本地测试</div><div class="line">if( &apos;development&apos; === app.get(&apos;env&apos;))&#123;</div><div class="line">    app.set(&apos;showStackError&apos;, true);            // 显示栈错误信息</div><div class="line">    app.use(logger(&apos;:method :url :status&apos;));    // 显示客户端请求信息（请求方式 url 状态）</div><div class="line">    app.locals.pretty = true;                   // 格式化代码</div><div class="line">    mongoose.set(&apos;debug&apos;, true);                // mongoose调试模式</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="调整目录结构，彻底分离MVC层"><a href="#调整目录结构，彻底分离MVC层" class="headerlink" title="调整目录结构，彻底分离MVC层"></a>调整目录结构，彻底分离MVC层</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── app/</div><div class="line">│   ├── controllers/</div><div class="line">│   │   ├── index.js</div><div class="line">│   │   ├── movie.js</div><div class="line">│   │   └── user.js</div><div class="line">│   ├── models/</div><div class="line">│   │   ├── movie.js</div><div class="line">│   │   └── user.js</div><div class="line">│   ├── schemas/</div><div class="line">│   │   ├── movie.js</div><div class="line">│   │   └── user.js</div><div class="line">│   └── views/</div><div class="line">│       ├── includes/</div><div class="line">│       │   ├── head.jade</div><div class="line">│       │   └── header.jade</div><div class="line">│       ├── pages/</div><div class="line">│       │   ├── admin.jade</div><div class="line">│       │   ├── detail.jade</div><div class="line">│       │   ├── index.jade</div><div class="line">│       │   ├── list.jade</div><div class="line">│       │   └── userlist.jade</div><div class="line">│       └── layout.jade</div><div class="line">├── config/</div><div class="line">│       └── routes.js</div><div class="line">│── public/</div><div class="line">│   ├── images/</div><div class="line">│   ├── js/</div><div class="line">│   └── libs/</div><div class="line">│       ├── bootstrap/</div><div class="line">│       └── jquery/</div><div class="line">├── .bowerrc</div><div class="line">├── README.md</div><div class="line">├── app.js</div><div class="line">├── bower.json</div><div class="line">└── package.json</div></pre></td></tr></table></figure>
<p>将app.js文件中路由相关代码移到控制器中，并在app.js中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require(&apos;./config/routes&apos;)(app);</div></pre></td></tr></table></figure></p>
<p>简化后的routes.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">let Index = require(&apos;../app/controllers/index&apos;);</div><div class="line">let User = require(&apos;../app/controllers/user&apos;);</div><div class="line">let Movie = require(&apos;../app/controllers/movie&apos;);</div><div class="line"></div><div class="line">module.exports = function(app) &#123;</div><div class="line">    // pre handle user</div><div class="line">    app.use(function(req, res, next)&#123;</div><div class="line">        let _user = req.session.user;</div><div class="line">        app.locals.user = _user;</div><div class="line">        next();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    // Index</div><div class="line">    app.get(&apos;/&apos;, Index.index);</div><div class="line"></div><div class="line">    // User</div><div class="line">    app.post(&apos;/user/signup&apos;, User.signup);</div><div class="line">    app.post(&apos;/user/signin&apos;, User.signin);</div><div class="line">    app.get(&apos;/logout&apos;, User.logout);</div><div class="line">    app.get(&apos;/admin/userlist&apos;, User.list);</div><div class="line"></div><div class="line">    // Movie</div><div class="line">    app.post(&apos;/admin/movie/new&apos;, Movie.save);</div><div class="line">    app.get(&apos;/movie/:id&apos;, Movie.detail);</div><div class="line">    app.get(&apos;/admin/movie&apos;, Movie.new);</div><div class="line">    app.get(&apos;/admin/update/:id&apos;, Movie.update);</div><div class="line">    app.get(&apos;/admin/list&apos;, Movie.list);</div><div class="line">    app.delete(&apos;/admin/delete&apos;, Movie.delete);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>/app/controllers/index.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">let Movie = require(&apos;../models/movie&apos;);</div><div class="line"></div><div class="line">// index page</div><div class="line">exports.index = function(req, res)&#123;</div><div class="line">    // console.log(&quot;user in session: &quot;);</div><div class="line">    // console.log(req.session.user);</div><div class="line"></div><div class="line">    Movie.fetch(function(err, movies)&#123;</div><div class="line">        if(err)&#123;</div><div class="line">            console.log(err);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        res.render(&apos;index&apos;, &#123;</div><div class="line">            title: &apos;MovieGoGo 首页&apos;,</div><div class="line">            movies: movies</div><div class="line">        &#125;);</div><div class="line">    &#125;)</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>/app/controllers/movie.js、 /app/controllers/user.js 与 /app/controllers/index.js 类似。</p>
<h4 id="增加注册登录跳转页面"><a href="#增加注册登录跳转页面" class="headerlink" title="增加注册登录跳转页面"></a>增加注册登录跳转页面</h4><p>routes.js中增加两条路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/signup&apos;, User.showSignup);</div><div class="line">app.get(&apos;/signin&apos;, User.showSignin);</div></pre></td></tr></table></figure></p>
<p>controllers/user.js中增加两个方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">exports.showSignup = function(req, res)&#123;</div><div class="line">    res.render(&apos;signup&apos;, &#123;</div><div class="line">        title: &quot;注册&quot;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.showSignin = function(req, res)&#123;</div><div class="line">    res.render(&apos;signin&apos;, &#123;</div><div class="line">        title: &quot;登录&quot;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>增加signup.jade和signin.jade两个页面（与之前的模态窗口类似）。</p>
<h4 id="用户权限管理"><a href="#用户权限管理" class="headerlink" title="用户权限管理"></a>用户权限管理</h4><p>schemas/user.js中增加字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">role: &#123;</div><div class="line">        // 0 - normal user</div><div class="line">        // 1 - verified user</div><div class="line">        // 2 - professional user</div><div class="line">        // ...</div><div class="line">        // &gt;10 - admin</div><div class="line">        // &gt;50 - super admin</div><div class="line">        type: Number,</div><div class="line">        default: 0</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>controllers/user.js中增加两个中间件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// middleware for user</div><div class="line">exports.signinRequired = function(req, res, next)&#123;</div><div class="line">    let user = req.session.user;</div><div class="line">    if(!user)&#123;</div><div class="line">        res.redirect(&apos;/signin&apos;);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.adminRequired = function(req, res, next)&#123;</div><div class="line">    let user = req.session.user;</div><div class="line">    if(user.role &lt;= 10)&#123;</div><div class="line">        res.redirect(&apos;/signin&apos;);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>规范路由命名，并修改相关文件的路由信息，如： public/js/admin.js 等。<br>为所有以 admin 开头的路由增加中间件 User.signinRequired 和 User.adminRequired。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// Index</div><div class="line">app.get(&apos;/&apos;, Index.index);</div><div class="line"></div><div class="line">// User</div><div class="line">app.post(&apos;/user/signup&apos;, User.signup);</div><div class="line">app.post(&apos;/user/signin&apos;, User.signin);</div><div class="line">app.get(&apos;/signup&apos;, User.showSignup);</div><div class="line">app.get(&apos;/signin&apos;, User.showSignin);</div><div class="line">app.get(&apos;/logout&apos;, User.logout);</div><div class="line">app.get(&apos;/admin/user/list&apos;, User.signinRequired, User.adminRequired, User.list);</div><div class="line"></div><div class="line">// Movie</div><div class="line">app.post(&apos;/admin/movie/save&apos;, User.signinRequired, User.adminRequired, Movie.save);</div><div class="line">app.get(&apos;/movie/:id&apos;, Movie.detail);</div><div class="line">app.get(&apos;/admin/movie/new&apos;, User.signinRequired, User.adminRequired, Movie.new);</div><div class="line">app.get(&apos;/admin/movie/update/:id&apos;, User.signinRequired, User.adminRequired, Movie.update);</div><div class="line">app.get(&apos;/admin/movie/list&apos;, User.signinRequired, User.adminRequired, Movie.list);</div><div class="line">app.delete(&apos;/admin/movie/delete&apos;, User.signinRequired, User.adminRequired, Movie.delete);</div></pre></td></tr></table></figure></p>
<h3 id="开发评论和回复功能"><a href="#开发评论和回复功能" class="headerlink" title="开发评论和回复功能"></a>开发评论和回复功能</h3><p><em>注</em>：只有登陆的用户才能发表评论和回复</p>
<h4 id="设计评论和回复的数据模型"><a href="#设计评论和回复的数据模型" class="headerlink" title="设计评论和回复的数据模型"></a>设计评论和回复的数据模型</h4><p>schemas/comment.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">let mongoose = require(&apos;mongoose&apos;);</div><div class="line">let Schema = mongoose.Schema;</div><div class="line">let ObjectId = Schema.Types.ObjectId;</div><div class="line"></div><div class="line">let CommentSchema = new mongoose.Schema(&#123;</div><div class="line">  movie: &#123;</div><div class="line">    type: ObjectId,</div><div class="line">    ref: &apos;Movie&apos;</div><div class="line">  &#125;,</div><div class="line">  from: &#123;</div><div class="line">    type: ObjectId,</div><div class="line">    ref: &apos;User&apos;</div><div class="line">  &#125;,</div><div class="line">  reply: [&#123;</div><div class="line">    from: &#123;</div><div class="line">      type: ObjectId,</div><div class="line">      ref: &apos;User&apos;</div><div class="line">    &#125;,</div><div class="line">    to: &#123;</div><div class="line">      type: ObjectId,</div><div class="line">      ref: &apos;User&apos;</div><div class="line">    &#125;,</div><div class="line">    content: String</div><div class="line">  &#125;]，</div><div class="line">  content: String,</div><div class="line">  meta: &#123;</div><div class="line">    createAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;,</div><div class="line">    updateAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="评论及回复的存储与展现"><a href="#评论及回复的存储与展现" class="headerlink" title="评论及回复的存储与展现"></a>评论及回复的存储与展现</h4><p>#####　在detail.jade中添加评论区和回复区：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">.panel.panel-default</div><div class="line">  .panel-heading</div><div class="line">    h3 评论区</div><div class="line">  .panel-body</div><div class="line">    ul.media-list</div><div class="line">  if comments</div><div class="line">    each item in comments</div><div class="line">      li(style=&quot;list-style-type:none&quot;).media</div><div class="line">        .pull-left</div><div class="line">          a.comment(href=&quot;#comment&quot;, data-cid=&quot;#&#123;item._id&#125;&quot;, data-tid=&quot;#&#123;item.from._id&#125;&quot;)</div><div class="line">            img.media-object(src=&quot;/images/avatar.jpg&quot;, style=&quot;width: 48px; height: 48px;&quot;)</div><div class="line">        .media-body</div><div class="line">          h4.media-heading #&#123;item.from.name&#125;</div><div class="line">          p #&#123;item.content&#125;</div><div class="line">          //- 回复部分</div><div class="line">          if item.reply &amp;&amp; item.reply.length &gt; 0</div><div class="line">            each reply in item.reply</div><div class="line">              .media</div><div class="line">                .pull-left</div><div class="line">                  a.comment(href=&quot;#comment&quot;, data-cid=&quot;#&#123;item._id&#125;&quot;, data-tid=&quot;#&#123;reply.from._id&#125;&quot;)</div><div class="line">                    img.media-object(src=&quot;/images/avatar.jpg&quot;, style=&quot;width: 48px; height: 48px;&quot;)</div><div class="line">                .media-body</div><div class="line">                  h4.media-heading</div><div class="line">                    | #&#123;reply.from.name&#125;</div><div class="line">                    span.text-info &amp;nbsp;回复&amp;nbsp;</div><div class="line">                    | #&#123;reply.to.name&#125;</div><div class="line">                  p #&#123;reply.content&#125;</div><div class="line">            //- 回复部分结束</div><div class="line">  #comment</div><div class="line">    form#commentForm(method=&quot;post&quot;, action=&quot;/user/comment&quot;)</div><div class="line">      input(type=&quot;hidden&quot;, name=&quot;comment[movie]&quot;, value=&quot;#&#123;movie._id&#125;&quot;)</div><div class="line">      if user</div><div class="line">        input(type=&quot;hidden&quot;, name=&quot;comment[from]&quot;, value=&quot;#&#123;user._id&#125;&quot;)</div><div class="line">      .form-group</div><div class="line">        textarea.form-group(name=&quot;comment[content]&quot;, row=&quot;3&quot;)</div><div class="line">      if user</div><div class="line">        button.btn.btn-primary(type=&apos;submit&apos;) 提交</div><div class="line">      else</div><div class="line">        a.navbar-link(href=&quot;#&quot;, data-toggle=&quot;modal&quot;, data-target=&quot;#signinModal&quot;) 登录后评论</div><div class="line">  script(src=&quot;/js/detail.js&quot;)</div></pre></td></tr></table></figure></p>
<p>#####　添加路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/user/comment&apos;, User.signinRequired, Comment.save);</div></pre></td></tr></table></figure></p>
<p>#####　评论存储，新建models/comment.js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">let Comment = require(&apos;../models/comment&apos;);</div><div class="line"></div><div class="line">// Routes for comment</div><div class="line">exports.save = function(req, res)&#123;</div><div class="line">  let _comment = req.body.comment;</div><div class="line">  let movieId = _comment.movie;</div><div class="line"></div><div class="line">  if(_comment.cid)&#123;</div><div class="line">    Comment.findById(_comment.cid, function(err, comment)&#123;</div><div class="line">      let reply = &#123;</div><div class="line">        from: _comment.from,</div><div class="line">        to: _comment.tid,</div><div class="line">        content: _comment.content</div><div class="line">      &#125;;</div><div class="line">      comment.reply.push(reply);</div><div class="line">      comment.save(function(err, comment)&#123;</div><div class="line">        if(err)&#123;</div><div class="line">          console.log(err);</div><div class="line">        &#125;</div><div class="line">        res.redirect(&apos;/movie/&apos; + movieId);</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;else&#123;</div><div class="line">    let comment = new Comment(_comment);</div><div class="line">    comment.save(function(err, comment)&#123;</div><div class="line">      if(err)&#123;</div><div class="line">        console.log(err);</div><div class="line">      &#125;</div><div class="line">      res.redirect(&apos;/movie/&apos; + movieId);  // 评论后返回当前电影</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>#####　为头像增加点击事件：<br>public/js/detail.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$(function()&#123;</div><div class="line">  $(&apos;.comment&apos;).click(function(e)&#123;</div><div class="line">    let target = $(this);</div><div class="line">    let toId = target.data(&apos;tid&apos;);</div><div class="line">    let commentId = target.data(&apos;cid&apos;);</div><div class="line"></div><div class="line">    if($(&quot;#toId&quot;).length &gt; 0)&#123;</div><div class="line">      $(&quot;#toId&quot;).val(toId);</div><div class="line">    &#125;else&#123;</div><div class="line">      $(&apos;&lt;input&gt;&apos;).attr(&#123;</div><div class="line">        type: &apos;hidden&apos;,</div><div class="line">        id: &apos;toId&apos;,</div><div class="line">        name: &apos;comment[tid]&apos;,</div><div class="line">        value: toId</div><div class="line">      &#125;).appendTo(&apos;#commentForm&apos;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if($(&quot;#commentId&quot;).length &gt; 0)&#123;</div><div class="line">      $(&quot;#commentId&quot;).val(commentId);</div><div class="line">    &#125;else&#123;</div><div class="line">      $(&apos;&lt;input&gt;&apos;).attr(&#123;</div><div class="line">        type: &apos;hidden&apos;,</div><div class="line">        id: &apos;commentId&apos;,</div><div class="line">        name: &apos;comment[cid]&apos;,</div><div class="line">        value: commentId</div><div class="line">      &#125;).appendTo(&apos;#commentForm&apos;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>#####　展示评论和回复<br>对controllers/movie.js稍作修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">exports.detail = function(req, res)&#123;</div><div class="line">  let id = req.params.id;</div><div class="line">  Movie.findById(id, function(err, movie)&#123;</div><div class="line">    Comment</div><div class="line">    .find(&#123;movie: id&#125;)</div><div class="line">    .populate(&apos;from&apos;, &apos;name&apos;)       // 连表查询from的name字段，即评论人的名字</div><div class="line">    .populate(&apos;reply.from reply.to&apos;, &apos;name&apos;)  // 连表查询reply.from和reply.to的name字段，即回复人的名字和被回复人的名字</div><div class="line">    .exec(function(err, comments)&#123;</div><div class="line">      res.render(&apos;detail&apos;, &#123;</div><div class="line">        title: &quot;&quot; + movie.title,</div><div class="line">        movie: movie,</div><div class="line">        comments: comments</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="电影分类功能的实现"><a href="#电影分类功能的实现" class="headerlink" title="电影分类功能的实现"></a>电影分类功能的实现</h3><h4 id="分类的数据模型"><a href="#分类的数据模型" class="headerlink" title="分类的数据模型"></a>分类的数据模型</h4><p>schemas/category.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">let CategorySchema = new mongoose.Schema(&#123;</div><div class="line">  name: String,</div><div class="line">  movies: [&#123;</div><div class="line">    type: ObjectId,</div><div class="line">    ref: &apos;Movie&apos;</div><div class="line">  &#125;],</div><div class="line">  meta: &#123;</div><div class="line">    createAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;,</div><div class="line">    updateAt: &#123;</div><div class="line">      type: Date,</div><div class="line">      default: Date.now()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="分类后台录入及存储"><a href="#分类后台录入及存储" class="headerlink" title="分类后台录入及存储"></a>分类后台录入及存储</h4><h5 id="增加路由信息"><a href="#增加路由信息" class="headerlink" title="增加路由信息"></a>增加路由信息</h5><p>routes.js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">let Category = require(&apos;../app/controllers/category&apos;);</div><div class="line"></div><div class="line">// Category</div><div class="line">app.post(&apos;/admin/category/save&apos;, User.signinRequired, User.adminRequired, Category.save);</div><div class="line">app.get(&apos;/admin/category/new&apos;, User.signinRequired, User.adminRequired, Category.new);</div><div class="line">app.get(&apos;/admin/category/list&apos;, User.signinRequired, User.adminRequired, Category.list);</div></pre></td></tr></table></figure></p>
<h5 id="分类的控制器"><a href="#分类的控制器" class="headerlink" title="分类的控制器"></a>分类的控制器</h5><p>controllers/category.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">let Category = require(&apos;../models/category&apos;);</div><div class="line"></div><div class="line">// Routes for category</div><div class="line">exports.new = function(req, res)&#123;</div><div class="line">  res.render(&apos;admin_category&apos;, &#123;</div><div class="line">    title: &apos;后台分类录入页&apos;,</div><div class="line">    category: &#123;&#125;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.save = function(req, res)&#123;</div><div class="line">  let _category = req.body.category;</div><div class="line">  let category = new Caterory(_category);</div><div class="line"></div><div class="line">  category.save(function(err)&#123;</div><div class="line">    if(err)&#123;</div><div class="line">      console.log(err);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    res.redirect(&apos;/admin/category/list&apos;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.list = function(req, res)&#123;</div><div class="line">  Category.fetch(function(err, categories)&#123;</div><div class="line">    if(err)&#123;</div><div class="line">      console.log(err);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    res.render(&apos;catetorylist&apos;, &#123;</div><div class="line">      title: &apos;分类列表页&apos;,</div><div class="line">      categories: categories</div><div class="line">    &#125;);</div><div class="line">  &#125;)</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h5 id="增加相关页面"><a href="#增加相关页面" class="headerlink" title="增加相关页面"></a>增加相关页面</h5><p>admin_category.jade、categorylist.jade。（类似于admin.jade、list.jade，略）</p>
<h4 id="电影录入增加分类选择"><a href="#电影录入增加分类选择" class="headerlink" title="电影录入增加分类选择"></a>电影录入增加分类选择</h4><h5 id="为电影增加字段"><a href="#为电影增加字段" class="headerlink" title="为电影增加字段"></a>为电影增加字段</h5><p>修改schemas/movie.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let Schema = mongoose.Schema;</div><div class="line">let ObjectId = Schema.Types.ObjectId;</div><div class="line"></div><div class="line">category: &#123;</div><div class="line">    type: ObjectId,</div><div class="line">    ref: &apos;Category&apos;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h5 id="增加“电影分类”表单项"><a href="#增加“电影分类”表单项" class="headerlink" title="增加“电影分类”表单项"></a>增加“电影分类”表单项</h5><p>修改admin.jade：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">.form-group</div><div class="line">  label.col-sm-2.control-label(for=&quot;inputCategory&quot;) 电影分类</div><div class="line">    .col-sm-8</div><div class="line">      input#inputCategory.form-control(type=&quot;text&quot;, name=&quot;movie[category_new]&quot;)</div><div class="line">.form-group</div><div class="line">  label.col-sm-2.control-label(for=&quot;radioCategory&quot;)</div><div class="line">  each cat in categories</div><div class="line">    label.radio-inline</div><div class="line">      if movie._id</div><div class="line">        input#radioCategory(type=&quot;radio&quot;, name=&quot;movie[category]&quot;, value=cat._id, checked=cat._id.toString()==movie.category.toString())</div><div class="line">        | #&#123;cat.name&#125;</div><div class="line">      else</div><div class="line">        input#radioCategory(type=&quot;radio&quot;, name=&quot;movie[category]&quot;, value=cat._id)</div><div class="line">        | #&#123;cat.name&#125;</div></pre></td></tr></table></figure></p>
<h5 id="修改movie控制器"><a href="#修改movie控制器" class="headerlink" title="修改movie控制器"></a>修改movie控制器</h5><p>controllers/movie.js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">exports.new = function(req, res)&#123;</div><div class="line">  Category.find(&#123;&#125;, function(err, categories)&#123;</div><div class="line">    res.render(&apos;admin&apos;, &#123;</div><div class="line">      title: &apos;后台录入页&apos;,</div><div class="line">      categories: categories,</div><div class="line">      movie: &#123;&#125;</div><div class="line">    &#125;)</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.save = function(req, res)&#123;</div><div class="line">  let id = req.body.movie._id;</div><div class="line">  let movieObj = req.body.movie;</div><div class="line">  let _movie;</div><div class="line"></div><div class="line">  if(id)&#123;</div><div class="line">    //...</div><div class="line">  &#125;else&#123;</div><div class="line">    let categoryId = movieObj.category;</div><div class="line">    _movie = new Movie(movieObj);</div><div class="line">    _movie.save(function(err, movie)&#123;</div><div class="line">      if(err)&#123;</div><div class="line">        console.log(err);</div><div class="line">      &#125;</div><div class="line">      Category.findById(categoryId, function(err, category)&#123;</div><div class="line">        category.movies.push(movie._id);</div><div class="line">        category.save(function(err, category)&#123;</div><div class="line">          res.redirect(&apos;/admin/movie/list&apos;);</div><div class="line">        &#125;);</div><div class="line">      &#125;)</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.update = function(req, res)&#123;</div><div class="line">  let id = req.params.id;</div><div class="line">  if(id)&#123;</div><div class="line">    Movie.findById(id, function(err, movie)&#123;</div><div class="line">      Category.find(&#123;&#125;, function(err, categories)&#123;</div><div class="line">        res.render(&apos;admin&apos;, &#123;</div><div class="line">          title: &apos;后台更新页&apos;,</div><div class="line">          movie: movie,</div><div class="line">          categories: categories</div><div class="line">        &#125;);</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="分类效果展示"><a href="#分类效果展示" class="headerlink" title="分类效果展示"></a>分类效果展示</h4><h5 id="首页控制器"><a href="#首页控制器" class="headerlink" title="首页控制器"></a>首页控制器</h5><p>index.js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">exports.index = function(req, res)&#123;</div><div class="line">  Category</div><div class="line">    .find(&#123;&#125;)</div><div class="line">    .populate(&#123;path: &apos;movies&apos;, options: &#123;limit: 5&#125;&#125;)</div><div class="line">    .exec(function(err, categories)&#123;</div><div class="line">        if(err)&#123;</div><div class="line">          console.log(err);</div><div class="line">        &#125;</div><div class="line">        res.render(&apos;index&apos;, &#123;</div><div class="line">          title: &apos;首页&apos;,</div><div class="line">          categories: categories</div><div class="line">        &#125;);</div><div class="line">    &#125;)</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h5 id="首页视图"><a href="#首页视图" class="headerlink" title="首页视图"></a>首页视图</h5><p>index.jade<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">for cat in categories</div><div class="line">  .panel.panel-default</div><div class="line">    .panel-heading</div><div class="line">      h3 #&#123;cat.name&#125;</div><div class="line">    .panel-body</div><div class="line">      if cat.movies &amp;&amp; cat.movies.length &gt; 0</div><div class="line">        for item in cat.movies</div><div class="line">        //...</div></pre></td></tr></table></figure></p>
<h4 id="jsonp同步豆瓣数据"><a href="#jsonp同步豆瓣数据" class="headerlink" title="jsonp同步豆瓣数据"></a>jsonp同步豆瓣数据</h4><p>admin.jade 增加”豆瓣同步”表单项, 并引入admin.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.form-group</div><div class="line">  label.col-sm-2.control-label(for=&quot;inputTitle&quot;) 豆瓣同步</div><div class="line">    .col-sm-8</div><div class="line">      input#douban.form-control(type=&quot;text&quot;)</div><div class="line"></div><div class="line">script(src=&quot;/js/admin.js&quot;)</div></pre></td></tr></table></figure></p>
<p>编辑admin.js, 通过ajax加载豆瓣数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$(function()&#123;</div><div class="line">  //...</div><div class="line">  $(&apos;#douban&apos;).blur(function()&#123;</div><div class="line">    let id = $(this).val();   // 电影id</div><div class="line">    $.ajax(&#123;</div><div class="line">      url: &apos;https://api.douban.com/v2/movie/subject/&apos; + id,</div><div class="line">      cache: true,</div><div class="line">      type: &apos;get&apos;,</div><div class="line">      dataType: &apos;jsonp&apos;,</div><div class="line">      crossDomain: true,</div><div class="line">      jspnp: &apos;callback&apos;,</div><div class="line">      success: function(data)&#123;</div><div class="line">        $(&apos;#inputTitle&apos;).val(data.title);</div><div class="line">        $(&apos;#inputDirector&apos;).val(data.directors[0].name);</div><div class="line">        $(&apos;#inputCountry&apos;).val(data.countries[0]);</div><div class="line">        $(&apos;#inputPoster&apos;).val(data.images.large);</div><div class="line">        $(&apos;#inputShowAt&apos;).val(data.year);</div><div class="line">        $(&apos;#inputSummary&apos;).val(data.summary);</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在豆瓣电影中查找电影id，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://movie.douban.com/subject/26363254/?from=showing   // id=26363254</div></pre></td></tr></table></figure></p>
<p>输入表单后，效果如图：<br><img src="/uploads/douban-example.png" alt="Alt Text"></p>
<blockquote>
<p>豆瓣开发者文档： <a href="https://developers.douban.com/wiki/?title=guide" target="_blank" rel="external">https://developers.douban.com/wiki/?title=guide</a></p>
</blockquote>
<h4 id="电影录入增加自定义分类"><a href="#电影录入增加自定义分类" class="headerlink" title="电影录入增加自定义分类"></a>电影录入增加自定义分类</h4><p>修改controllers/movie.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">exports.save = function(req, res)&#123;</div><div class="line">  if(id)&#123;</div><div class="line">    //...</div><div class="line">  &#125;else&#123;</div><div class="line">    let categoryId = movieObj.category;</div><div class="line">    let categoryName = movieObj.category_new;</div><div class="line">    _movie = new Movie(movieObj);</div><div class="line">    _movie.save(function(err, movie)&#123;</div><div class="line">      if(err)&#123;</div><div class="line">        console.log(err);</div><div class="line">      &#125;</div><div class="line">      if(categoryId)&#123; // 已有分类</div><div class="line">        Category.findById(categoryId, function(err, category)&#123;</div><div class="line">          category.movies.push(movie._id);</div><div class="line">          category.save(function(err, category)&#123;</div><div class="line">            res.redirect(&apos;/admin/movie/list&apos;);</div><div class="line">          &#125;);</div><div class="line">        &#125;)</div><div class="line">      &#125;else if(categoryName)&#123; // 新分类</div><div class="line">        let category = new Category(&#123;</div><div class="line">          name: categoryName,</div><div class="line">          movies: [movie._id]</div><div class="line">        &#125;);</div><div class="line">        category.save(function(err, category)&#123;</div><div class="line">          _movie.category = category._id;</div><div class="line">          _movie.save(function(err, movie)&#123; // 注意：movie要保存两次</div><div class="line">            res.redirect(&apos;/admin/movie/list&apos;);</div><div class="line">          &#125;);</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="增加分类列表及分页"><a href="#增加分类列表及分页" class="headerlink" title="增加分类列表及分页"></a>增加分类列表及分页</h4><p>修改index.jade,为分类标题增加链接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">h3</div><div class="line">  a(href=&quot;/category/search?catId=#&#123;cat._id&#125;&amp;page=1&quot;) #&#123;cat.name&#125;</div></pre></td></tr></table></figure></p>
<p>增加路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/category/search&apos;, Category.search);</div></pre></td></tr></table></figure></p>
<p>增加后台逻辑处理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">exports.search = function(req, res)&#123;</div><div class="line">	let catId = req.query.catId;</div><div class="line">	let page = parseInt(req.query.page, 10) || 0;</div><div class="line">	let perPage = 5;</div><div class="line">	let index = (page - 1) * perPage;</div><div class="line"></div><div class="line">	Category</div><div class="line">		.find(&#123;_id: catId&#125;)</div><div class="line">		.populate(&#123;</div><div class="line">			path: &apos;movies&apos;,</div><div class="line">			select: &apos;title poster&apos;</div><div class="line">		&#125;)</div><div class="line">		.exec(function(err, categories)&#123;</div><div class="line">			if(err)&#123;</div><div class="line">				console.log(err);</div><div class="line">			&#125;</div><div class="line">			let category = categories[0] || &#123;&#125;;</div><div class="line">			let movies = category.movies || [];</div><div class="line">			let results = movies.slice(index, index + perPage);</div><div class="line"></div><div class="line">			res.render(&apos;results&apos;, &#123;</div><div class="line">				title: &apos;分类&apos;,</div><div class="line">				query: &apos;catId=&apos; + catId,</div><div class="line">				keyword: category.name,</div><div class="line">				currentPage: page,</div><div class="line">				totalPage: Math.ceil(movies.length / perPage),</div><div class="line">				movies: results</div><div class="line">			&#125;);</div><div class="line">		&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>展示页面results.jade：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">extends ../layout</div><div class="line"></div><div class="line">block content</div><div class="line">	.container</div><div class="line">		.row</div><div class="line">			.panel.panel-default</div><div class="line">				.panel-heading</div><div class="line">					h3</div><div class="line">						if query</div><div class="line">							a(href=&quot;/category/search?#&#123;query&#125;&amp;page=1&quot;) #&#123;keyword&#125;</div><div class="line">						else</div><div class="line">							a(href=&quot;/movie/search?keyword=#&#123;keyword&#125;&amp;page=1&quot;) #&#123;keyword&#125;</div><div class="line">				.panel-body</div><div class="line">					if movies &amp;&amp; movies.length &gt; 0</div><div class="line">						for item in movies</div><div class="line">							.col-md-2</div><div class="line">								.thumbnail</div><div class="line">									a(href=&quot;/movie/#&#123;item._id&#125;&quot;)</div><div class="line">										img(src=&quot;#&#123;item.poster&#125;&quot;, alt=&quot;#&#123;item.title&#125;&quot;)</div><div class="line">									.caption</div><div class="line">										h3 #&#123;item.title&#125;</div><div class="line">										p: a.btn.btn-primary(href=&quot;/movie/#&#123;item._id&#125;&quot;, role=&quot;button&quot;) 观看预告片</div><div class="line">			ul.pagination.col-md-6.col-md-offset-3</div><div class="line">				- for(let i = 0; i &lt; totalPage; i++)&#123;</div><div class="line">					- if(currentPage == (i + 1))&#123;</div><div class="line">						li.active</div><div class="line">							span #&#123;currentPage&#125;</div><div class="line">					- &#125;else&#123;</div><div class="line">						li</div><div class="line">							if query</div><div class="line">								a(href=&apos;/category/search?#&#123;query&#125;&amp;page=#&#123;i + 1&#125;&apos;) #&#123;i + 1&#125;</div><div class="line">							else</div><div class="line">								a(href=&apos;/movie/search?keyword=#&#123;keyword&#125;&amp;page=#&#123;i + 1&#125;&apos;) #&#123;i + 1&#125;</div><div class="line">					- &#125;</div><div class="line">				- &#125;</div></pre></td></tr></table></figure></p>
<h4 id="搜索功能的实现"><a href="#搜索功能的实现" class="headerlink" title="搜索功能的实现"></a>搜索功能的实现</h4><p>增加搜索框head.jade:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">form.navbar-form.navbar-left(method=&quot;get&quot;, action=&quot;/movie/search&quot;)</div><div class="line">  .form-group</div><div class="line">    input.form-control(type=&quot;text&quot;, placeholder=&quot;Search&quot;, name=&quot;keyword&quot;)</div><div class="line">    button.btn.btn-default(type=&quot;submit&quot;) Submit</div></pre></td></tr></table></figure></p>
<p>增加路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 应放在 app.get(&apos;/movie/:id&apos;, Movie.detail) 之前，否则会有冲突</div><div class="line">app.get(&apos;/movie/search&apos;, Movie.search);</div></pre></td></tr></table></figure></p>
<p>增加后台逻辑处理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">exports.search = function(req, res)&#123;</div><div class="line">	let keyword = req.query.keyword;</div><div class="line">	let page = parseInt(req.query.page) || 1;</div><div class="line">	let perPage = 5;</div><div class="line">	Movie</div><div class="line">		.find(&#123;title: new RegExp(&apos;.*&apos; + keyword + &apos;.*&apos;)&#125;, function(err, movies)&#123;</div><div class="line">			if(err)&#123;</div><div class="line">				console.log(err);</div><div class="line">			&#125;</div><div class="line">			res.render(&apos;results&apos;, &#123;</div><div class="line">				title: &apos;分类&apos;,</div><div class="line">				keyword: keyword,</div><div class="line">				currentPage: page,</div><div class="line">				totalPage: Math.ceil(movies.length / perPage),</div><div class="line">				movies: movies</div><div class="line">			&#125;)</div><div class="line">		&#125;)</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="上传海报"><a href="#上传海报" class="headerlink" title="上传海报"></a>上传海报</h4><p>增加文件选择表单项<br>admin.jade:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">form.form-horizontal(method=&quot;post&quot;, action=&quot;/admin/movie/save&quot;, enctype=&quot;multipart/form-data&quot;)</div><div class="line">  .form-group</div><div class="line">    label.col-sm-2.control-label(for=&quot;uploadPoster&quot;) 上传海报</div><div class="line">    .col-sm-8</div><div class="line">      input#uploadPoster(type=&quot;file&quot;, name=&quot;uploadPoster&quot;)</div></pre></td></tr></table></figure></p>
<p>为系统增加中间件：(cnpm install connect-multiparty –save)<br>app.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let multipart = require(&apos;connect-multiparty&apos;);</div><div class="line">app.use(multipart());</div></pre></td></tr></table></figure></p>
<p>为保存电影增加中间件posterUploaded，以保证图片上传成功（这里最好采用异步方式）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/admin/movie/save&apos;, User.signinRequired, User.adminRequired, Movie.posterUploaded, Movie.save);</div></pre></td></tr></table></figure></p>
<p>具体实现，controllers/movie.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">exports.posterUploaded = function(req, res, next)&#123;</div><div class="line">	let posterData = req.files.uploadPoster;</div><div class="line">	let filePath = posterData.path;</div><div class="line">	let originalFilename = posterData.originalFilename;</div><div class="line"></div><div class="line">	if(originalFilename)&#123;</div><div class="line">		fs.readFile(filePath, function(err, data)&#123;</div><div class="line">			let timestamp = Date.now();</div><div class="line">			let type = posterData.type.split(&apos;/&apos;)[1];</div><div class="line">			let newPosterName = timestamp + &apos;.&apos; + type;</div><div class="line">			let newPath = path.join(__dirname, &apos;../../public/images/&apos; + newPosterName);</div><div class="line"></div><div class="line">			fs.writeFile(newPath, data, function(err)&#123;</div><div class="line">				req.newPosterName = &apos;/images/&apos; + newPosterName;</div><div class="line">				next();</div><div class="line">			&#125;)</div><div class="line">		&#125;)</div><div class="line">	&#125;else&#123;</div><div class="line">		next();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在保存电影之前，判断是否上传了图片，并替换之：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">exports.save = function(req, res)&#123;</div><div class="line">	let movieObj = req.body.movie;</div><div class="line"></div><div class="line">	if(req.newPosterName)&#123;</div><div class="line">		movieObj.poster = req.newPosterName;</div><div class="line">	&#125;</div><div class="line">  //...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="访客统计"><a href="#访客统计" class="headerlink" title="访客统计"></a>访客统计</h4><p>为movie增加字段:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pv: &#123;</div><div class="line">  type: Number,</div><div class="line">  default: 0</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>每当访问详情页时，访问量 +1 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">exports.detail = function(req, res)&#123;</div><div class="line">	let id = req.params.id;</div><div class="line">	Movie.update(&#123;_id: id&#125;, &#123;$inc: &#123;pv: 1&#125;&#125;, function(err)&#123;</div><div class="line">		if(err)&#123;</div><div class="line">			console.log(err);</div><div class="line">		&#125;</div><div class="line">	&#125;)</div><div class="line">	// ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>展示：在列表页增加“访客统计”字段，即可。</p>
<blockquote>
<p><a href="https://jochen-m.github.io/2017/05/26/Nodejs-Express-MongoDB快速搭建网站/">《Nodejs + Express + MongoDB快速搭建网站》</a></p>
</blockquote>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/06/28/Hadoop-2.8.0实践(一)/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/06/15/mongoose简单操作实例/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="Jochen-M's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        Jochen_M@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                Home
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    Archives
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/11/">November 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">September 2017<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">July 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">June 2017<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                Categories
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Algorithm/">Algorithm<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/categories/Big-Data/">Big Data<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/Docker/">Docker<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Github/">Github<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/Java/">Java<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/Nodejs/">Nodejs<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/PHP/">PHP<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Ubuntu/">Ubuntu<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/timeline" title="Timeline">
                
                    <i class="material-icons sidebar-material-icons">schedule</i>
                
                Timeline
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                    <i class="material-icons sidebar-material-icons">label</i>
                
                Tags
            </a>
        </li>
        
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    
        <a href="http://weibo.com/u/5054297276?refer_flag=1001030201_" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/Jochen-M" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Jochen-M
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
